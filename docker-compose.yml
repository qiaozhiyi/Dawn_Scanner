# docker-compose.yml for Dawn Scanner
version: '3.8'

services:
  go-backend:
    build:
      context: ./go-backend
      dockerfile: Dockerfile
    container_name: dawn-scanner-backend
    ports:
      - "8080:8080"
    environment:
      - GO_ENV=production
      - PORT=8080
      - LLM_SERVICE_URL=http://llm-service:8000
      - PYTHON_WORKER_URL=http://python-worker:9000
      - DEFAULT_AUTH_TOKEN=dawn_scanner_dev_token
      - TASK_STORE_PATH=/app/data/tasks/tasks.json
    volumes:
      - dawn-data:/app/data
      - ./logs:/app/logs
    depends_on:
      - llm-service
      - python-worker
    restart: unless-stopped

  python-worker:
    build:
      context: .
      dockerfile: python-worker/Dockerfile
    container_name: dawn-scanner-worker
    ports:
      - "9000:9000"
    environment:
      - PYTHON_ENV=production
      - PORT=9000
      - SCAN_TIMEOUT=300
    volumes:
      - dawn-data:/app/data
    restart: unless-stopped

  llm-service:
    build:
      context: .
      dockerfile: llm-service/Dockerfile
    container_name: dawn-scanner-llm
    ports:
      - "8000:8000"
    environment:
      - ENV=production
      - PORT=8000
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
    volumes:
      - dawn-data:/app/data
    restart: unless-stopped

  # 开发环境服务
  dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dawn-scanner-dev
    ports:
      - "8080:8080"
      - "8000:8000"
    environment:
      - GO_ENV=development
      - PYTHON_ENV=development
      - ENV=development
      - PORT=8080
      - LLM_SERVICE_URL=http://llm-service:8000
      - PYTHON_WORKER_URL=http://python-worker:9000
      - DEFAULT_AUTH_TOKEN=dawn_scanner_dev_token
    volumes:
      - .:/app
      - dawn-data:/app/data
    stdin_open: true
    tty: true
    command: bash
    depends_on:
      - llm-service

volumes:
  dawn-data:
    driver: local
